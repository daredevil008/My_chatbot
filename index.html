<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LiaBot - J.A.R.V.I.S.</title>

  <style>
    /* --- RESET & FONT --- */
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Helvetica, Arial, sans-serif;
    }

    /* --- COLOR PALETTE --- */
    :root {
      --bg-primary: #020617;
      --bg-secondary: #0b1120;
      --bg-header: #020617;
      --bg-bubble-bot: #020617;
      --bg-bubble-user: #16a34a;
      --text-primary: #e5e7eb;
      --accent-teal: #22c55e;
      --input-field: #020617;
      --status-color: #38bdf8;
    }

    /* --- BODY & APP CONTAINER (Glassmorphism) --- */
    body {
      background: radial-gradient(circle at top, #1f2933, #020617);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    #app-container {
      width: 100%;
      max-width: 480px;
      height: 92vh;
      background: rgba(15, 23, 42, 0.88);
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.65);
    }

    /* --- HEADER --- */
    header {
      background: linear-gradient(135deg, #020617, #111827);
      padding: 12px 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a);
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
    }

    header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
    }

    .status {
      font-size: 12px;
      color: var(--status-color);
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      gap: 8px;
    }

    .header-pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.16);
      color: #6ee7b7;
      border: 1px solid rgba(45, 212, 191, 0.4);
      cursor: pointer;
    }

    /* --- CHAT AREA --- */
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Hide scrollbar for cleaner look */
    #chat::-webkit-scrollbar {
      display: none;
    }
    #chat {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* --- BUBBLES --- */
    .message-row {
      display: flex;
      width: 100%;
    }

    .bubble {
      max-width: 78%;
      padding: 9px 13px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 19px;
      color: var(--text-primary);
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
      position: relative;
    }

    .user-row {
      justify-content: flex-end;
    }
    .bot-row {
      justify-content: flex-start;
    }

    .user-bubble {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-bottom-right-radius: 2px;
    }

    .bot-bubble {
      background: linear-gradient(135deg, #020617, #111827);
      border-bottom-left-radius: 2px;
    }

    .meta {
      font-size: 10px;
      opacity: 0.85;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 5px;
    }

    /* Sentiment chips */
    .sentiment-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .sentiment-positive {
      background: rgba(22, 163, 74, 0.2);
      color: #4ade80;
      border: 1px solid rgba(74, 222, 128, 0.4);
    }

    .sentiment-negative {
      background: rgba(220, 38, 38, 0.18);
      color: #fca5a5;
      border: 1px solid rgba(252, 165, 165, 0.4);
    }

    .sentiment-neutral {
      background: rgba(148, 163, 184, 0.18);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    /* --- INPUT AREA & BUTTONS --- */
    .input-area {
      background: rgba(15, 23, 42, 0.92);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
    }

    #msg {
      flex: 1;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 11px 14px;
      border-radius: 999px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
    }

    #msg::placeholder {
      color: #6b7280;
    }

    #send-btn {
      background: radial-gradient(circle at 30% 0, #22c55e, #16a34a);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s ease, box-shadow 0.15s ease,
        filter 0.15s ease;
    }

    #send-btn:hover {
      transform: translateY(-1px) scale(1.04);
      filter: brightness(1.05);
    }

    #send-btn svg {
      fill: white;
      width: 20px;
      height: 20px;
      margin-left: 2px;
    }

    .chat-control-btn {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 7px 10px;
      border-radius: 999px;
      color: var(--text-primary);
      font-size: 11px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .chat-control-btn:hover {
      background: rgba(30, 64, 175, 0.8);
      transform: translateY(-1px);
    }

    /* --- HISTORY PANEL --- */
    #history-panel {
      position: fixed;
      top: 0;
      right: -420px;
      width: 420px;
      max-width: 100%;
      height: 100vh;
      background: rgba(15, 23, 42, 0.97);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      transition: right 0.3s ease;
      padding: 16px 18px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: -2px 0 24px rgba(0, 0, 0, 0.6);
      color: var(--text-primary);
    }

    #history-panel.open {
      right: 0;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    #history-content {
      margin-top: 8px;
    }

    .history-chat {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .history-chat h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
    }

    .history-chat p {
      margin: 2px 0;
      font-size: 12px;
      color: #9ca3af;
    }

    .history-chat details {
      margin-top: 6px;
      font-size: 12px;
    }

    /* Small screens */
    @media (max-width: 520px) {
      #app-container {
        height: 100vh;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <!-- Header -->
    <header>
      <div class="header-left">
        <div class="avatar">J</div>
        <div>
          <h2>J.A.R.V.I.S.</h2>
          <div class="status">online · sentiment active</div>
        </div>
      </div>
      <div class="header-right">
        <button id="history-btn" class="header-pill">History</button>
      </div>
    </header>

    <!-- Chat Area -->
    <div id="chat"></div>

    <!-- Input Area -->
    <div class="input-area">
      <input id="msg" type="text" placeholder="Type a message" />
      <button id="end-chat-btn" class="chat-control-btn">End Chat</button>
      <button id="new-chat-btn" class="chat-control-btn">New Chat</button>
      <button id="send-btn">
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- History Panel -->
  <div id="history-panel">
    <div class="history-header">
      <h3>Chat History</h3>
      <button id="close-history" class="chat-control-btn">Close</button>
    </div>
    <div id="history-content"></div>
  </div>

  <script>
    // Global state
    let currentChat = {
      id: Date.now(),
      messages: [],
      sentiments: [],
      overallSentiment: null
    };
    let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];

    // DOM elements
    const chatBox = document.getElementById("chat");
    const inputField = document.getElementById("msg");
    const sendButton = document.getElementById("send-btn");
    const endChatBtn = document.getElementById("end-chat-btn");
    const newChatBtn = document.getElementById("new-chat-btn");
    const historyBtn = document.getElementById("history-btn");
    const historyPanel = document.getElementById("history-panel");
    const closeHistoryBtn = document.getElementById("close-history");

    // Event listeners
    inputField.addEventListener("keydown", handleEnter);
    sendButton.addEventListener("click", send);
    endChatBtn.addEventListener("click", endCurrentChat);
    newChatBtn.addEventListener("click", startNewChat);
    historyBtn.addEventListener("click", toggleHistory);
    closeHistoryBtn.addEventListener("click", toggleHistory);

    // Handle Enter key
    function handleEnter(e) {
      if (e.key === "Enter") send();
    }

    // Creates and adds a message bubble
    function addMessage(text, sender, meta = null) {
      const row = document.createElement("div");
      row.className = `message-row ${sender}-row`;

      const bubble = document.createElement("div");
      bubble.className = `bubble ${sender}-bubble`;

      const textSpan = document.createElement("div");
      textSpan.innerText = text;
      bubble.appendChild(textSpan);

      if (meta) {
        const metaTag = document.createElement("span");
        metaTag.className = "meta";
        metaTag.innerText = meta;
        bubble.appendChild(metaTag);
      }

      row.appendChild(bubble);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;

      return row;
    }

    // Track message in current chat
    function trackMessage(sender, text, sentiment = null) {
      currentChat.messages.push({ sender, text });
      if (sentiment) {
        currentChat.sentiments.push(sentiment);
      } else {
        currentChat.sentiments.push(null);
      }
    }

    // Calculate overall sentiment
    function calculateOverallSentiment() {
      const valid = currentChat.sentiments.filter(Boolean);
      if (valid.length === 0) return "Neutral";

      const sentimentCounts = { Positive: 0, Negative: 0, Neutral: 0 };
      valid.forEach((s) => {
        if (sentimentCounts[s] !== undefined) {
          sentimentCounts[s]++;
        } else {
          sentimentCounts.Neutral++;
        }
      });

      const total = valid.length;
      let maxSentiment = "Neutral";
      let maxCount = 0;
      for (let s in sentimentCounts) {
        if (sentimentCounts[s] > maxCount) {
          maxCount = sentimentCounts[s];
          maxSentiment = s;
        }
      }
      const percent = Math.round((maxCount / total) * 100);
      return `${maxSentiment} (${percent}%)`;
    }

    // End current chat
    function endCurrentChat() {
      if (currentChat.messages.length === 0) return;

      currentChat.overallSentiment = calculateOverallSentiment();
      chatHistory.unshift(currentChat);
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));

      const analysisText =
        "Chat Analysis Complete\n\n" +
        `Overall Sentiment: ${currentChat.overallSentiment}\n` +
        `Total Messages: ${currentChat.messages.length}\n` +
        `Sentiments Analyzed: ${
          currentChat.sentiments.filter(Boolean).length
        }`;

      addMessage(analysisText, "bot", "ANALYSIS");

      inputField.disabled = true;
      sendButton.disabled = true;
      endChatBtn.disabled = true;

      renderHistory();
    }

    // Start new chat
    function startNewChat() {
      // If current chat has messages and not yet ended, end and save
      if (currentChat.messages.length > 0 && !currentChat.overallSentiment) {
        endCurrentChat();
      }

      chatBox.innerHTML = "";
      inputField.disabled = false;
      sendButton.disabled = false;
      endChatBtn.disabled = false;
      inputField.value = "";
      inputField.focus();

      currentChat = {
        id: Date.now(),
        messages: [],
        sentiments: [],
        overallSentiment: null
      };

      addMessage("New chat started! How can I help you today?", "bot");
    }

    // Toggle history panel
    function toggleHistory() {
      historyPanel.classList.toggle("open");
      if (historyPanel.classList.contains("open")) {
        renderHistory();
      }
    }

    // Render chat history
    function renderHistory() {
      const content = document.getElementById("history-content");
      if (!content) return;

      if (chatHistory.length === 0) {
        content.innerHTML = "<p>No chats yet.</p>";
        return;
      }

      content.innerHTML = chatHistory
        .map((chat) => {
          const overall = chat.overallSentiment || "Neutral";
          const time = new Date(chat.id).toLocaleString();
          const msgsHtml = chat.messages
            .map((msg, i) => {
              const s = chat.sentiments[i];
              let sentimentSpan = "";
              if (s) {
                const cls =
                  s === "Positive"
                    ? "sentiment-positive"
                    : s === "Negative"
                    ? "sentiment-negative"
                    : "sentiment-neutral";
                sentimentSpan = `<span class="sentiment-tag ${cls}" style="margin-left:6px;">${s}</span>`;
              }
              return `<div style="margin:4px 0;">
                        <strong>${msg.sender}:</strong> ${msg.text}${sentimentSpan}
                      </div>`;
            })
            .join("");

          return `
            <div class="history-chat">
              <h4>Chat – ${time}</h4>
              <p><strong>Overall:</strong> ${overall}</p>
              <details>
                <summary>View Messages (${chat.messages.length})</summary>
                ${msgsHtml}
              </details>
            </div>
          `;
        })
        .join("");
    }

    // Main send function (with sentiment chips)
    async function send() {
      const text = inputField.value.trim();
      if (!text) return;

      // User message
      trackMessage("user", text);
      addMessage(text, "user");
      inputField.value = "";

      // Typing indicator
      const loadingRow = addMessage("Typing...", "bot");
      const loadingBubble = loadingRow.querySelector(".bot-bubble");
      if (loadingBubble) {
        loadingBubble.style.fontStyle = "italic";
        loadingBubble.style.color = "var(--status-color)";
      }

      try {
        const response = await fetch("/api/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });

        if (!response.ok) throw new Error("Network error");

        const data = await response.json();
        loadingRow.remove();

        const sentimentLabel = data.sentiment ? data.sentiment.label : "Neutral";
        trackMessage("bot", data.bot, sentimentLabel);

        const sentimentClass =
          sentimentLabel === "Positive"
            ? "sentiment-positive"
            : sentimentLabel === "Negative"
            ? "sentiment-negative"
            : "sentiment-neutral";

        const row = addMessage(data.bot, "bot");
        const bubble = row.querySelector(".bot-bubble");

        const meta = document.createElement("span");
        meta.className = `meta sentiment-tag ${sentimentClass}`;
        meta.innerText = sentimentLabel;
        bubble.appendChild(meta);
      } catch (error) {
        console.error("API Error:", error);
        if (loadingRow) loadingRow.remove();
        trackMessage("bot", "Error: Could not connect to the bot.", null);
        addMessage("Error: Could not connect to the bot.", "bot");
      }
    }

    // Initial welcome message
    addMessage(
      "Hii sir myself J.A.R.V.I.S! Start chatting (sorry I'm a bit work in progress).",
      "bot"
    );
  </script>
</body>
</html>
